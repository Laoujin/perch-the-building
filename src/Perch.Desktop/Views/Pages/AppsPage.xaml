<Page
    x:Class="Perch.Desktop.Views.Pages.AppsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:Perch.Desktop.ViewModels"
    xmlns:models="clr-namespace:Perch.Desktop.Models"
    xmlns:controls="clr-namespace:Perch.Desktop.Views.Controls"
    d:DataContext="{d:DesignInstance vm:AppsViewModel}"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Foreground="White"
    Loaded="OnLoaded">

    <Grid Margin="24,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="Auto" />
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <ui:TextBlock Grid.Column="0" FontTypography="Title" Text="Applications" />

            <!-- Status summary -->
            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0,0,0">
                <TextBlock FontSize="11" Foreground="#888888">
                    <Run Text="{Binding LinkedCount, Mode=OneWay}" Foreground="#34D399" FontWeight="SemiBold" />
                    <Run Text=" linked" />
                </TextBlock>
                <TextBlock FontSize="11" Foreground="#888888" Margin="12,0,0,0"
                           Visibility="{Binding DriftedCount, Converter={StaticResource CountToVisibilityConverter}}">
                    <Run Text="{Binding DriftedCount, Mode=OneWay}" Foreground="#F59E0B" FontWeight="SemiBold" />
                    <Run Text=" drifted" />
                </TextBlock>
                <TextBlock FontSize="11" Foreground="#888888" Margin="12,0,0,0"
                           Visibility="{Binding DetectedCount, Converter={StaticResource CountToVisibilityConverter}}">
                    <Run Text="{Binding DetectedCount, Mode=OneWay}" Foreground="#3B82F6" FontWeight="SemiBold" />
                    <Run Text=" detected" />
                </TextBlock>
            </StackPanel>

            <StackPanel Grid.Column="3" Orientation="Horizontal">
                <ui:TextBox
                    PlaceholderText="Search apps..."
                    Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                    Width="200"
                    Margin="0,0,8,0" />
                <ui:Button
                    Icon="{ui:SymbolIcon ArrowClockwise24}"
                    Command="{Binding RefreshCommand}" />
            </StackPanel>
        </Grid>

        <!-- Loading -->
        <ui:ProgressRing
            Grid.Row="1"
            IsIndeterminate="True"
            Width="32"
            Height="32"
            HorizontalAlignment="Center"
            VerticalAlignment="Center"
            Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />

        <!-- Error banner -->
        <ScrollViewer
            Grid.Row="1"
            Panel.ZIndex="10"
            Margin="0,16,0,0"
            VerticalScrollBarVisibility="Auto"
            HorizontalScrollBarVisibility="Disabled"
            Visibility="{Binding ErrorMessage, Converter={StaticResource CountToVisibilityConverter}}">
            <Border
                Background="#331111"
                CornerRadius="8"
                Padding="16">
                <StackPanel HorizontalAlignment="Center" MaxWidth="500">
                    <Image Source="/Assets/wizard-error.png" Width="640" Height="640" Margin="0,0,0,16"
                           Stretch="Uniform" HorizontalAlignment="Center" />
                    <TextBlock Text="Failed to load apps" FontSize="16" FontWeight="SemiBold"
                               Foreground="#EF4444" HorizontalAlignment="Center" Margin="0,0,0,8" />
                    <TextBox Text="{Binding ErrorMessage, Mode=OneWay}" IsReadOnly="True"
                             Foreground="#DC2626" FontSize="12" Background="Transparent" BorderThickness="0"
                             TextWrapping="Wrap" Margin="0" Focusable="True" IsHitTestVisible="True"
                             VerticalScrollBarVisibility="Hidden" HorizontalAlignment="Center" />
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- Scrollable 3-tier content -->
        <ScrollViewer
            Grid.Row="1"
            Margin="0,16,0,0"
            VerticalScrollBarVisibility="Auto"
            Visibility="{Binding IsLoading, Converter={StaticResource InverseBooleanToVisibilityConverter}}">
            <StackPanel>

                <!-- Tier 1: Your Apps -->
                <StackPanel Visibility="{Binding YourApps.Count, Converter={StaticResource CountToVisibilityConverter}, FallbackValue=Collapsed}">
                    <controls:TierSectionHeader
                        Title="Your Apps"
                        ItemCount="{Binding YourApps.Count}" />
                    <ItemsControl ItemsSource="{Binding YourApps}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:AppCardModel}">
                                <controls:AppCard
                                    DisplayLabel="{Binding DisplayLabel}"
                                    Description="{Binding Description}"
                                    Category="{Binding Category}"
                                    Status="{Binding Status}"
                                    Website="{Binding Website}"
                                    GitHub="{Binding GitHub}"
                                    IsManaged="{Binding IsManaged}"
                                    CanToggle="{Binding CanToggle}"
                                    ToggleChanged="OnToggleChanged"
                                    Margin="0,0,12,12" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- Tier 2: Suggested -->
                <StackPanel Visibility="{Binding SuggestedApps.Count, Converter={StaticResource CountToVisibilityConverter}, FallbackValue=Collapsed}">
                    <controls:TierSectionHeader
                        Title="Suggested for You"
                        ItemCount="{Binding SuggestedApps.Count}" />
                    <ItemsControl ItemsSource="{Binding SuggestedApps}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:AppCardModel}">
                                <controls:AppCard
                                    DisplayLabel="{Binding DisplayLabel}"
                                    Description="{Binding Description}"
                                    Category="{Binding Category}"
                                    Status="{Binding Status}"
                                    Website="{Binding Website}"
                                    GitHub="{Binding GitHub}"
                                    IsManaged="{Binding IsManaged}"
                                    CanToggle="{Binding CanToggle}"
                                    ToggleChanged="OnToggleChanged"
                                    Margin="0,0,12,12" />
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

                <!-- Tier 3: Browse All -->
                <StackPanel Visibility="{Binding BrowseCategories.Count, Converter={StaticResource CountToVisibilityConverter}, FallbackValue=Collapsed}">
                    <controls:TierSectionHeader
                        Title="Browse All"
                        ItemCount="{Binding BrowseCategories.Count}" />
                    <ItemsControl ItemsSource="{Binding BrowseCategories}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate DataType="{x:Type models:AppCategoryCardModel}">
                                <StackPanel>
                                    <!-- Collapsed category card -->
                                    <Border
                                        Background="#1A1A2E"
                                        BorderBrush="#333350"
                                        BorderThickness="1"
                                        CornerRadius="8"
                                        Padding="12"
                                        Margin="0,0,0,8"
                                        Cursor="Hand"
                                        MouseLeftButtonUp="OnBrowseCategoryClick">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="*" />
                                                <ColumnDefinition Width="Auto" />
                                                <ColumnDefinition Width="Auto" />
                                            </Grid.ColumnDefinitions>

                                            <ui:SymbolIcon
                                                Grid.Column="0"
                                                Symbol="{Binding IconSymbol}"
                                                FontSize="20"
                                                Foreground="#10B981"
                                                VerticalAlignment="Center"
                                                Margin="0,0,12,0" />

                                            <TextBlock
                                                Grid.Column="1"
                                                Text="{Binding DisplayName}"
                                                FontSize="14"
                                                FontWeight="SemiBold"
                                                Foreground="White"
                                                VerticalAlignment="Center" />

                                            <TextBlock
                                                Grid.Column="2"
                                                FontSize="11"
                                                Foreground="#888888"
                                                VerticalAlignment="Center"
                                                Margin="0,0,12,0">
                                                <Run Text="{Binding ItemCount, Mode=OneWay}" />
                                                <Run Text=" apps" />
                                            </TextBlock>

                                            <ui:SymbolIcon
                                                Grid.Column="3"
                                                Symbol="ChevronDown24"
                                                FontSize="12"
                                                Foreground="#666666"
                                                VerticalAlignment="Center"
                                                RenderTransformOrigin="0.5,0.5">
                                                <ui:SymbolIcon.Style>
                                                    <Style TargetType="ui:SymbolIcon">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding IsExpanded}" Value="True">
                                                                <Setter Property="RenderTransform">
                                                                    <Setter.Value>
                                                                        <RotateTransform Angle="180" />
                                                                    </Setter.Value>
                                                                </Setter>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </ui:SymbolIcon.Style>
                                            </ui:SymbolIcon>
                                        </Grid>
                                    </Border>

                                    <!-- Expanded app cards -->
                                    <ItemsControl
                                        x:Name="CategoryAppsPanel"
                                        Visibility="{Binding IsExpanded, Converter={StaticResource BooleanToVisibilityConverter}}"
                                        Margin="0,0,0,12"
                                        Tag="{Binding BroadCategory}"
                                        Loaded="OnCategoryAppsPanelLoaded">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Margin="24,0,0,0" />
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate DataType="{x:Type models:AppCardModel}">
                                                <controls:AppCard
                                                    DisplayLabel="{Binding DisplayLabel}"
                                                    Description="{Binding Description}"
                                                    Category="{Binding Category}"
                                                    Status="{Binding Status}"
                                                    Website="{Binding Website}"
                                                    GitHub="{Binding GitHub}"
                                                    IsManaged="{Binding IsManaged}"
                                                    CanToggle="{Binding CanToggle}"
                                                    ToggleChanged="OnToggleChanged"
                                                    Margin="0,0,12,12" />
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>

            </StackPanel>
        </ScrollViewer>
    </Grid>

</Page>
