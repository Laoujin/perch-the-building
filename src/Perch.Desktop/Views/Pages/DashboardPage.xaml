<Page
    x:Class="Perch.Desktop.Views.Pages.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:Perch.Desktop.ViewModels"
    d:DataContext="{d:DesignInstance vm:DashboardViewModel}"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Loaded="OnLoaded">

    <Grid Margin="24,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Hero Banner with hero.png background -->
        <Border
            Grid.Row="0"
            CornerRadius="8"
            ClipToBounds="True"
            MinHeight="120">
            <Border.Background>
                <ImageBrush
                    ImageSource="/Assets/hero.png"
                    Stretch="UniformToFill"
                    AlignmentX="Center"
                    AlignmentY="Center" />
            </Border.Background>

            <!-- Dark overlay for text readability -->
            <Border Background="#CC000000" Padding="24,20">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>

                    <ui:TextBlock
                        Grid.Row="0"
                        FontTypography="Subtitle"
                        Foreground="White"
                        Text="{Binding HealthMessage}" />

                    <StackPanel
                        Grid.Row="1"
                        Orientation="Horizontal"
                        Margin="0,12,0,0"
                        Visibility="{Binding HasConfigRepo, Converter={StaticResource BooleanToVisibilityConverter}}">
                        <Border CornerRadius="4" Padding="12,6" Background="#4434D399" Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="CheckmarkCircle24" Foreground="#34D399" Margin="0,0,6,0" />
                                <ui:TextBlock Text="{Binding OkCount, StringFormat='{}{0} OK'}" Foreground="#34D399" />
                            </StackPanel>
                        </Border>
                        <Border CornerRadius="4" Padding="12,6" Background="#44F59E0B" Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="Warning24" Foreground="#F59E0B" Margin="0,0,6,0" />
                                <ui:TextBlock Text="{Binding MissingCount, StringFormat='{}{0} Missing'}" Foreground="#F59E0B" />
                            </StackPanel>
                        </Border>
                        <Border CornerRadius="4" Padding="12,6" Background="#44F59E0B" Margin="0,0,8,0">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="ArrowSync24" Foreground="#F59E0B" Margin="0,0,6,0" />
                                <ui:TextBlock Text="{Binding DriftCount, StringFormat='{}{0} Drift'}" Foreground="#F59E0B" />
                            </StackPanel>
                        </Border>
                        <Border CornerRadius="4" Padding="12,6" Background="#44EF4444">
                            <StackPanel Orientation="Horizontal">
                                <ui:SymbolIcon Symbol="ErrorCircle24" Foreground="#EF4444" Margin="0,0,6,0" />
                                <ui:TextBlock Text="{Binding ErrorCount, StringFormat='{}{0} Errors'}" Foreground="#EF4444" />
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Grid>
            </Border>
        </Border>

        <!-- Refresh Button + Loading -->
        <StackPanel
            Grid.Row="1"
            Orientation="Horizontal"
            Margin="0,16,0,0">
            <ui:Button
                Content="Refresh"
                Icon="{ui:SymbolIcon ArrowClockwise24}"
                Command="{Binding RefreshCommand}"
                IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}" />
            <ui:ProgressRing
                IsIndeterminate="True"
                Width="20"
                Height="20"
                Margin="12,0,0,0"
                Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
        </StackPanel>

        <!-- Attention Items -->
        <Grid Grid.Row="2" Margin="0,16,0,0">
            <!-- No config message -->
            <ui:TextBlock
                FontTypography="Body"
                Text="No config repository configured. Go to Settings to set one up."
                Opacity="0.6"
                Visibility="{Binding HasConfigRepo, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
                VerticalAlignment="Center"
                HorizontalAlignment="Center" />

            <!-- Items list -->
            <ListView
                ItemsSource="{Binding AttentionItems}"
                Visibility="{Binding HasConfigRepo, Converter={StaticResource BooleanToVisibilityConverter}}"
                ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                <ListView.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:StatusItemViewModel}">
                        <Border
                            Padding="16,12"
                            Margin="0,0,0,4"
                            CornerRadius="4"
                            Background="{DynamicResource ControlFillColorDefaultBrush}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto" />
                                    <RowDefinition Height="Auto" />
                                </Grid.RowDefinitions>

                                <Border
                                    Grid.Column="0"
                                    Grid.RowSpan="2"
                                    CornerRadius="4"
                                    Padding="8,4"
                                    Margin="0,0,12,0"
                                    VerticalAlignment="Center"
                                    Background="{DynamicResource SystemFillColorCriticalBackgroundBrush}">
                                    <ui:TextBlock
                                        FontTypography="Caption"
                                        Text="{Binding LevelDisplay}" />
                                </Border>

                                <ui:TextBlock
                                    Grid.Column="1"
                                    Grid.Row="0"
                                    FontTypography="BodyStrong"
                                    Text="{Binding ModuleName}" />

                                <ui:TextBlock
                                    Grid.Column="1"
                                    Grid.Row="1"
                                    FontTypography="Caption"
                                    Opacity="0.6"
                                    Text="{Binding Message}"
                                    TextTrimming="CharacterEllipsis" />

                                <ui:TextBlock
                                    Grid.Column="2"
                                    Grid.RowSpan="2"
                                    FontTypography="Caption"
                                    Opacity="0.4"
                                    VerticalAlignment="Center"
                                    Text="{Binding Category}" />
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ListView.ItemTemplate>
            </ListView>
        </Grid>

        <!-- Logo watermark bottom-right -->
        <Image
            Grid.Row="2"
            Source="/Assets/logo.png"
            Width="48"
            Height="48"
            Opacity="0.15"
            HorizontalAlignment="Right"
            VerticalAlignment="Bottom"
            Margin="0,0,8,8"
            IsHitTestVisible="False" />
    </Grid>

</Page>
