<Page
    x:Class="Perch.Desktop.Views.Pages.DashboardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:vm="clr-namespace:Perch.Desktop.ViewModels"
    xmlns:controls="clr-namespace:Perch.Desktop.Views.Controls"
    xmlns:status="clr-namespace:Perch.Core.Status;assembly=Perch.Core"
    d:DataContext="{d:DesignInstance vm:DashboardViewModel}"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d"
    Foreground="White"
    Loaded="OnLoaded">

    <Grid Margin="24,16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Drift Hero Banner -->
        <controls:DriftHeroBanner
            Grid.Row="0"
            LinkedCount="{Binding LinkedCount}"
            LinkedAppsCount="{Binding LinkedAppsCount}"
            LinkedDotfilesCount="{Binding LinkedDotfilesCount}"
            LinkedTweaksCount="{Binding LinkedTweaksCount}"
            AttentionCount="{Binding AttentionCount}"
            BrokenCount="{Binding BrokenCount}"
            HealthPercent="{Binding HealthPercent}"
            StatusMessage="{Binding StatusMessage}"
            controls:DriftHeroBanner.LaunchWizardRequested="OnLaunchWizard" />

        <!-- Loading indicator -->
        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,12"
                    Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ui:ProgressRing
                IsIndeterminate="True"
                Width="20"
                Height="20"
                VerticalAlignment="Center" />
            <TextBlock
                Text="Checking status..."
                Foreground="#888888"
                FontSize="12"
                VerticalAlignment="Center"
                Margin="8,0,0,0" />
        </StackPanel>

        <!-- Pending Changes -->
        <Border
            Grid.Row="2"
            Background="#1A1A2E"
            BorderBrush="#2A2A3E"
            BorderThickness="1"
            CornerRadius="8"
            Padding="16,12"
            Margin="0,0,0,12"
            Visibility="{Binding HasPendingChanges, Converter={StaticResource BooleanToVisibilityConverter}}">
            <StackPanel>
                <Grid Margin="0,0,0,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="Auto" />
                    </Grid.ColumnDefinitions>

                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <ui:SymbolIcon Symbol="ClipboardTask24" Foreground="#10B981" Margin="0,0,8,0" />
                        <TextBlock FontSize="14" FontWeight="SemiBold" Foreground="White">
                            <Run Text="{Binding PendingChangeCount, Mode=OneWay}" />
                            <Run Text="pending change(s)" />
                        </TextBlock>
                    </StackPanel>

                    <ui:Button
                        Grid.Column="1"
                        Content="Discard All"
                        Appearance="Secondary"
                        Command="{Binding DiscardAllCommand}"
                        Margin="0,0,8,0" />

                    <ui:Button
                        Grid.Column="2"
                        Content="Apply All"
                        Appearance="Primary"
                        Command="{Binding ApplyAllCommand}"
                        IsEnabled="{Binding IsApplying, Converter={StaticResource InverseBooleanConverter}}" />
                </Grid>

                <ItemsControl ItemsSource="{Binding PendingChanges}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border
                                Background="#12121E"
                                CornerRadius="4"
                                Padding="12,8"
                                Margin="0,0,0,4">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto" />
                                        <ColumnDefinition Width="*" />
                                        <ColumnDefinition Width="Auto" />
                                    </Grid.ColumnDefinitions>

                                    <ToggleButton
                                        Grid.Column="0"
                                        IsChecked="{Binding IsAdditive, Mode=OneWay}"
                                        VerticalAlignment="Center"
                                        Margin="0,0,10,0"
                                        Click="OnPendingToggle" />

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock
                                            Text="{Binding DisplayName}"
                                            FontSize="12"
                                            FontWeight="SemiBold"
                                            Foreground="White" />
                                        <TextBlock
                                            Text="{Binding Description}"
                                            FontSize="10"
                                            Foreground="#888888" />
                                    </StackPanel>

                                    <ui:Button
                                        Grid.Column="2"
                                        Icon="{ui:SymbolIcon Dismiss24}"
                                        Appearance="Secondary"
                                        VerticalAlignment="Center"
                                        Padding="4"
                                        Click="OnDiscardChange"
                                        ToolTip="Discard this change" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </StackPanel>
        </Border>

        <!-- No config message -->
        <ui:TextBlock
            Grid.Row="3"
            FontTypography="Body"
            Text="No config repository configured. Go to Settings to set one up."
            Opacity="0.6"
            Visibility="{Binding HasConfigRepo, Converter={StaticResource InverseBooleanToVisibilityConverter}}"
            VerticalAlignment="Center"
            HorizontalAlignment="Center" />

        <!-- Attention items -->
        <ScrollViewer
            Grid.Row="3"
            VerticalScrollBarVisibility="Auto"
            Visibility="{Binding HasConfigRepo, Converter={StaticResource BooleanToVisibilityConverter}}">
            <ItemsControl ItemsSource="{Binding AttentionItems}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:StatusItemViewModel}">
                        <Border
                            Background="#1A1A2E"
                            BorderBrush="#2A2A3E"
                            BorderThickness="1"
                            CornerRadius="8"
                            Padding="16,12"
                            Margin="0,0,0,8">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" />
                                    <ColumnDefinition Width="*" />
                                    <ColumnDefinition Width="Auto" />
                                </Grid.ColumnDefinitions>

                                <ui:SymbolIcon
                                    Grid.Column="0"
                                    Margin="0,0,12,0"
                                    VerticalAlignment="Center">
                                    <ui:SymbolIcon.Style>
                                        <Style TargetType="ui:SymbolIcon">
                                            <Setter Property="Symbol" Value="Warning24" />
                                            <Setter Property="Foreground" Value="#F59E0B" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static status:DriftLevel.Error}">
                                                    <Setter Property="Symbol" Value="DismissCircle24" />
                                                    <Setter Property="Foreground" Value="#EF4444" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </ui:SymbolIcon.Style>
                                </ui:SymbolIcon>

                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                    <TextBlock
                                        Text="{Binding ModuleName}"
                                        FontSize="13"
                                        FontWeight="SemiBold"
                                        Foreground="White" />
                                    <TextBlock
                                        Text="{Binding Message}"
                                        FontSize="11"
                                        Foreground="#888888"
                                        TextTrimming="CharacterEllipsis" />
                                </StackPanel>

                                <Border
                                    Grid.Column="2"
                                    CornerRadius="4"
                                    Padding="8,4"
                                    VerticalAlignment="Center">
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Setter Property="Background" Value="#26F59E0B" />
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding Level}" Value="{x:Static status:DriftLevel.Error}">
                                                    <Setter Property="Background" Value="#26EF4444" />
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                    <TextBlock
                                        Text="{Binding LevelDisplay}"
                                        FontSize="10"
                                        FontWeight="SemiBold">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="#F59E0B" />
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Level}" Value="{x:Static status:DriftLevel.Error}">
                                                        <Setter Property="Foreground" Value="#EF4444" />
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Border>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>
    </Grid>

</Page>
