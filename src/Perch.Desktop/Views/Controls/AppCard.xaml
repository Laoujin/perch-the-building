<UserControl
    x:Class="Perch.Desktop.Views.Controls.AppCard"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:controls="clr-namespace:Perch.Desktop.Views.Controls">
    <Border
        x:Name="CardBorder"
        Background="{StaticResource CardBackgroundBrush}"
        BorderThickness="1"
        CornerRadius="8"
        Padding="12"
        Width="280">
        <Border.Style>
            <Style TargetType="Border">
                <Setter Property="BorderBrush" Value="{StaticResource CardBorderBrush}" />
                <Style.Triggers>
                    <DataTrigger Binding="{Binding IsManaged, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                        <Setter Property="BorderBrush" Value="{StaticResource AccentBrush}" />
                    </DataTrigger>
                </Style.Triggers>
            </Style>
        </Border.Style>
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
                <RowDefinition Height="Auto" />
            </Grid.RowDefinitions>

            <!-- Row 0: Status ribbon + badges + detail button -->
            <Grid Grid.Row="0" Margin="0,0,0,6">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <controls:StatusRibbon
                    Grid.Column="0"
                    Status="{Binding Status, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    VerticalAlignment="Center" />

                <!-- Suggested badge -->
                <Border
                    Grid.Column="1"
                    Background="{StaticResource SuggestedBadgeBrush}"
                    CornerRadius="4"
                    Padding="4,1"
                    Margin="4,0,0,0"
                    VerticalAlignment="Center"
                    Visibility="{Binding IsSuggested, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Suggested" FontSize="9" Foreground="{StaticResource SuggestedTextBrush}" />
                </Border>

                <!-- Kind badge -->
                <Border
                    Grid.Column="2"
                    Background="{StaticResource CardBorderBrush}"
                    CornerRadius="4"
                    Padding="4,1"
                    Margin="4,0,0,0"
                    VerticalAlignment="Center"
                    Visibility="{Binding KindBadge, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}">
                    <TextBlock
                        Text="{Binding KindBadge, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        FontSize="9"
                        Foreground="{StaticResource TextMutedBrush}" />
                </Border>

                <!-- Hot badge -->
                <Border
                    Grid.Column="3"
                    Background="{StaticResource HotBadgeBrush}"
                    CornerRadius="4"
                    Padding="4,1"
                    Margin="4,0,0,0"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Left"
                    Visibility="{Binding IsHot, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <TextBlock Text="Hot" FontSize="9" Foreground="{StaticResource HotTextBrush}" />
                </Border>

                <!-- GitHub stars badge -->
                <Border
                    Grid.Column="4"
                    Background="{StaticResource SurfaceBrush}"
                    CornerRadius="10"
                    Margin="4,0,0,0"
                    VerticalAlignment="Center"
                    HorizontalAlignment="Left"
                    Visibility="{Binding GitHubStarsFormatted, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}">
                    <Button
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="6,1"
                        Click="OnLinkClick"
                        Tag="{Binding GitHub, RelativeSource={RelativeSource AncestorType=UserControl}}"
                        ToolTip="{Binding GitHub, RelativeSource={RelativeSource AncestorType=UserControl}}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#x2605;" FontSize="9" Foreground="{StaticResource WarningBrush}" />
                            <TextBlock
                                Text="{Binding GitHubStarsFormatted, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                FontSize="9"
                                Foreground="White"
                                Margin="3,0,0,0" />
                        </StackPanel>
                    </Button>
                </Border>

                <ui:Button
                    Grid.Column="5"
                    Icon="{ui:SymbolIcon Settings24}"
                    Appearance="Secondary"
                    Padding="2"
                    Margin="4,0"
                    VerticalAlignment="Center"
                    Click="OnConfigureClick"
                    ToolTip="View details"
                    Visibility="{Binding HasDetailPage, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BooleanToVisibilityConverter}}" />
            </Grid>

            <!-- Row 1: Logo + Name -->
            <Grid Grid.Row="1">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0" Width="24" Height="24" VerticalAlignment="Center" Margin="0,0,8,0">
                    <Border
                        x:Name="FallbackIcon"
                        Width="24"
                        Height="24"
                        CornerRadius="12"
                        Background="{StaticResource CardBorderBrush}">
                        <TextBlock
                            x:Name="FallbackInitial"
                            FontSize="12"
                            FontWeight="SemiBold"
                            Foreground="{StaticResource TextSubtleBrush}"
                            HorizontalAlignment="Center"
                            VerticalAlignment="Center" />
                    </Border>
                    <Border CornerRadius="12" Width="24" Height="24">
                        <Border.Clip>
                            <EllipseGeometry Center="12,12" RadiusX="12" RadiusY="12" />
                        </Border.Clip>
                        <Image
                            x:Name="LogoImage"
                            Width="24"
                            Height="24"
                            Stretch="UniformToFill"
                            RenderOptions.BitmapScalingMode="HighQuality" />
                    </Border>
                </Grid>

                <TextBlock
                    Grid.Column="1"
                    Text="{Binding DisplayLabel, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    FontSize="13"
                    FontWeight="SemiBold"
                    Foreground="White"
                    VerticalAlignment="Center"
                    TextTrimming="CharacterEllipsis" />
            </Grid>

            <!-- Row 2: Description (2-line max) -->
            <TextBlock
                Grid.Row="2"
                Text="{Binding Description, RelativeSource={RelativeSource AncestorType=UserControl}}"
                FontSize="11"
                Foreground="{StaticResource TextMutedBrush}"
                TextWrapping="Wrap"
                TextTrimming="CharacterEllipsis"
                MaxHeight="32"
                Margin="0,4,0,0"
                Visibility="{Binding Description, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}" />

            <!-- Row 3: Links bar (Website, Docs, GitHub) -->
            <StackPanel
                Grid.Row="3"
                Orientation="Horizontal"
                Margin="0,6,0,0">
                <Button
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="4,2"
                    Margin="0,0,4,0"
                    Click="OnLinkClick"
                    Tag="{Binding Website, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    ToolTip="{Binding Website, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    Visibility="{Binding Website, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="Globe24" FontSize="12" Foreground="{StaticResource LinkTextBrush}" />
                        <TextBlock Text="Website" FontSize="10" Foreground="{StaticResource LinkTextBrush}" Margin="4,0,0,0" VerticalAlignment="Center" />
                    </StackPanel>
                </Button>
                <Button
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="4,2"
                    Margin="0,0,4,0"
                    Click="OnLinkClick"
                    Tag="{Binding Docs, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    ToolTip="{Binding Docs, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    Visibility="{Binding Docs, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="Document24" FontSize="12" Foreground="{StaticResource LinkTextBrush}" />
                        <TextBlock Text="Docs" FontSize="10" Foreground="{StaticResource LinkTextBrush}" Margin="4,0,0,0" VerticalAlignment="Center" />
                    </StackPanel>
                </Button>
                <Button
                    Background="Transparent"
                    BorderThickness="0"
                    Padding="4,2"
                    Click="OnOpenLocationClick"
                    Tag="{Binding ConfigPath, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    ToolTip="{Binding ConfigPath, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    Visibility="{Binding ConfigPath, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <ui:SymbolIcon Symbol="FolderOpen24" FontSize="12" Foreground="{StaticResource LinkTextBrush}" />
                        <TextBlock Text="Open Location" FontSize="10" Foreground="{StaticResource LinkTextBrush}" Margin="4,0,0,0" VerticalAlignment="Center" />
                    </StackPanel>
                </Button>
            </StackPanel>

            <!-- Row 4: Tag pills -->
            <ItemsControl
                Grid.Row="4"
                Margin="0,6,0,0"
                Visibility="{Binding Tags, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource CountToVisibilityConverter}}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemsSource>
                    <Binding Path="Tags" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                </ItemsControl.ItemsSource>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border
                            Background="{StaticResource CardBorderBrush}"
                            CornerRadius="8"
                            Padding="6,2"
                            Margin="0,0,4,2"
                            Cursor="Hand"
                            MouseLeftButtonUp="OnTagClick">
                            <TextBlock Text="{Binding}" FontSize="10" Foreground="{StaticResource TextSubtleBrush}" />
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Row 5: License badge -->
            <Border
                Grid.Row="5"
                Background="{StaticResource CardBorderBrush}"
                CornerRadius="4"
                Padding="4,1"
                Margin="0,6,0,0"
                HorizontalAlignment="Left"
                Visibility="{Binding License, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource NullToVisibilityConverter}}">
                <TextBlock
                    Text="{Binding License, RelativeSource={RelativeSource AncestorType=UserControl}}"
                    FontSize="9"
                    Foreground="{StaticResource TextSubtleBrush}" />
            </Border>

            <!-- Row 6: Action button -->
            <ui:Button
                Grid.Row="6"
                Content="{Binding ActionButtonText, RelativeSource={RelativeSource AncestorType=UserControl}}"
                HorizontalAlignment="Stretch"
                Padding="8,6"
                FontSize="11"
                Margin="0,8,0,0"
                Click="OnActionClick">
                <ui:Button.Style>
                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                        <Setter Property="Appearance" Value="Secondary" />
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding IsActionAdd, RelativeSource={RelativeSource AncestorType=UserControl}}" Value="True">
                                <Setter Property="Appearance" Value="Primary" />
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ui:Button.Style>
            </ui:Button>
        </Grid>
    </Border>
</UserControl>
